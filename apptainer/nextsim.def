Bootstrap: docker
From: ubuntu:22.04
Stage: build


%files
    nextsim.sh /etc/profile.d/nextsim.sh


%post
    # install libraries
    apt-get update --fix-missing
    apt-get install -y --no-install-recommends \
        apt-transport-https \
        ca-certificates \
        cmake \
        g++ \
        git \
        gcc \
        gfortran \
        grsync \
        libblas-dev \
        libboost1.74-all-dev \
        liblapack-dev \
        libnetcdf-dev \
        libnetcdf-c++4-dev \
        libopenmpi-dev \
        libx11-dev \
        make \
        rsync \
        openmpi-bin \
        netcdf-bin \
        unzip \
        valgrind \
        wget \
        zip

    update-ca-certificates
    apt-get clean
    rm -rf /var/lib/apt/lists/*

    # set some variables
    . /etc/profile.d/nextsim.sh

    # install gmsh
    mkdir /gmsh
    cd /gmsh
    wget -nc -nv --no-check-certificate \
       https://gitlab.onelab.info/gmsh/gmsh/-/archive/gmsh_3_0_6/gmsh-gmsh_3_0_6.tar.gz
    tar -xzf gmsh-gmsh_3_0_6.tar.gz
    cd /gmsh/gmsh-gmsh_3_0_6
    cmake \
        -DCMAKE_INSTALL_PREFIX=/opt/local/gmsh \
        -DENABLE_BUILD_LIB=ON \
        -DENABLE_BUILD_SHARED=ON \
        -DENABLE_BUILD_DYNAMIC=ON \
        -DCMAKE_BUILD_TYPE=release \
        -DENABLE_MPI=OFF \
        -DENABLE_MUMPS=OFF \
        -DENABLE_PETSC=OFF \
        -DENABLE_OPENMP=OFF \
        -DENABLE_MMG3D=OFF
    make -j8
    make install

    # clean up
    cd /
    rm -r /gmsh*

%environment
    . /etc/profile.d/nextsim.sh

%test
    grep -q NAME=\"Ubuntu\" /etc/os-release
    if [ $? -eq 0 ]
    then
        echo "Container base is Ubuntu as expected."
    else
        echo "Container base is not Ubuntu."
        exit 1
    fi

%labels
    Author Timothy Williams
    Version v0.0.1

%help
    This is an ubuntu container with required external libraries
    to compile and run nextsim

